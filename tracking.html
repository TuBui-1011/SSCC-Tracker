<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <title>Quản Lý SSCC</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link
      rel="stylesheet"
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdn.datatables.net/1.10.21/css/dataTables.bootstrap4.min.css"
    />
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.datatables.net/1.10.21/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.10.21/js/dataTables.bootstrap4.min.js"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js"></script>
  </head>
  <body class="bg-light">
    <div class="container mt-5">
      <h3 class="mb-4"><i class="fas fa-list-alt mr-2"></i> Quản Lý SSCC</h3>
      <table
        id="ssccTable"
        class="table table-striped table-bordered"
        style="width: 100%"
      >
        <thead class="thead-dark">
          <tr>
            <th>STT</th>
            <th>SSCC</th>
            <th>Material Code</th>
            <th>Batch</th>
            <th>Shift</th>
            <th>Date</th>
            <th>Time</th>
            <th>Status</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody>
          <!-- Dữ liệu sẽ được thêm bằng JS hoặc backend -->
        </tbody>
      </table>
    </div>
    <!-- Modal xác nhận xóa -->
    <div
      class="modal fade"
      id="confirmDeleteModal"
      tabindex="-1"
      role="dialog"
      aria-labelledby="confirmDeleteLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title text-center" id="confirmDeleteLabel">
              <i class="fas fa-exclamation-triangle text-danger mr-2"></i>Xác
              nhận xóa
            </h5>
            <button
              type="button"
              class="close"
              data-dismiss="modal"
              aria-label="Đóng"
            >
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            Bạn có chắc chắn muốn xóa thông tin này không?
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-dismiss="modal"
            >
              Hủy
            </button>
            <button type="button" class="btn btn-danger" id="deleteRowBtn">
              Xóa
            </button>
          </div>
        </div>
      </div>
    </div>
    <script>
      $(document).ready(function () {
        // Lấy lịch sử kiểm tra từ localStorage
        let history = JSON.parse(localStorage.getItem("ssccHistory") || "[]");

        // Chuẩn bị dữ liệu cho DataTable
        const tableData = history.map((item, idx) => {
          let dateStr = "-",
            timeStr = "-";
          if (item.Time) {
            const d = new Date(item.Time);
            dateStr = d.toLocaleDateString();
            timeStr = d.toLocaleTimeString();
          }
          return [
            idx + 1,
            item.SSCC,
            item.MaterialCode || "-",
            item.Batch || "-",
            item.Shift || "-",
            dateStr, // Cột Date
            timeStr, // Cột Time
            `<span class="badge badge-${
              item.Status === "Hợp Lệ" ? "success" : "danger"
            }">${item.Status}</span>`,
            `<button class="btn btn-sm btn-outline-primary mr-2" title="Sửa"><i class="fas fa-edit"></i></button>
             <button class="btn btn-sm btn-outline-danger btn-delete-row" title="Xóa"><i class="fas fa-trash-alt"></i></button>`,
          ];
        });

        const table = $("#ssccTable").DataTable({
          data: tableData,
          columns: [
            { title: "STT" },
            { title: "SSCC" },
            { title: "Material Code" },
            { title: "Batch" },
            { title: "Shift" },
            { title: "Date" }, // Thêm cột Date
            { title: "Time" }, // Thêm cột Time
            { title: "Status" },
            { title: "Action" },
          ],
          language: {
            search: "Tìm kiếm:",
            lengthMenu: "Hiển thị _MENU_ dòng",
            info: "Hiển thị _START_ đến _END_ của _TOTAL_ dòng",
            emptyTable: "Không có dữ liệu",
            paginate: {
              first: "Đầu",
              last: "Cuối",
              next: "Sau",
              previous: "Trước",
            },
          },
        });

        let rowToDelete = null;

        // Sự kiện click nút xóa
        $("#ssccTable tbody").on("click", ".btn-delete-row", function () {
          rowToDelete = table.row($(this).closest("tr"));
          $("#confirmDeleteModal").modal("show");
        });

        // Xác nhận xóa
        $("#deleteRowBtn").on("click", function () {
          if (rowToDelete) {
            // Xóa khỏi DataTable
            const rowData = rowToDelete.data();
            table.row(rowToDelete).remove().draw();

            // Xóa khỏi localStorage (dựa vào SSCC và Time nếu có)
            let history = JSON.parse(
              localStorage.getItem("ssccHistory") || "[]"
            );
            // rowData[1] là SSCC
            history = history.filter((item) => item.SSCC !== rowData[1]);
            localStorage.setItem("ssccHistory", JSON.stringify(history));

            $("#confirmDeleteModal").modal("hide");
            rowToDelete = null;
          }
        });
      });
    </script>
  </body>
</html>
